Версия: 1.3

Дата: 22 апреля 2025 г.

## **1. Введение**

Данный документ описывает требования к системе (набору скриптов Node.js и инфраструктуре), предназначенной для автоматизации процесса обработки данных для нескольких независимых модулей (например, "модулей телефонии"). Процесс начинается с **опционального начального преобразования файлов формата `.docx` в Markdown с помощью `pandoc`, включая извлечение изображений**. Затем система обрабатывает Markdown-файлы: выполняет предобработку (замена изображений на Mermaid-диаграммы, разделение по заголовкам), извлекает структурированную информацию с помощью больших языковых моделей (LLM), и загружает данные в реляционную (Supabase/PostgreSQL) и векторную (Qdrant) базы данных для использования в системах поиска по смыслу (RAG). Система должна быть легко развертываема на платформе Coolify и удобна для передачи заказчику. Исходные данные для основного конвейера будут храниться исключительно в Git-репозитории в формате Markdown. В дальнейшем планируется создание пользовательского интерфейса на базе n8n, который будет взаимодействовать с данными, подготовленными этой системой (возможно, через API, которое выходит за рамки данного PRD).

## **2. Цели проекта**

- **Обеспечить возможность начальной конвертации** документов из формата `.docx` в Markdown с сохранением изображений.
    
- **Автоматизировать** процесс подготовки данных из Markdown-файлов для RAG-систем.
    
- **Реализовать поддержку нескольких модулей** с полной изоляцией данных на уровне хранилищ (логическая изоляция в Qdrant).
    
- **Внедрить шаги предобработки:** замена изображений на Mermaid-диаграммы и семантическое разделение текста по заголовкам Markdown.
    
- **Интегрировать** внешние сервисы: Источник файлов (**Git**), OpenRouter (LLM), Supabase (реляционная БД), **vsegpt.ru (для векторизации с использованием моделей OpenAI)**, Qdrant (векторная БД).
    
- **Создать** воспроизводимый и конфигурируемый конвейер данных (data pipeline) на **Node.js**.
    
- **Обеспечить** простоту развертывания (**включая базы данных Supabase/PostgreSQL и Qdrant**) на **Coolify** и передачи системы заказчику (Docker, Git).
    

## **3. Системная Архитектура**

Система состоит из предварительного шага конвертации и основного конвейера обработки данных, работающего для каждого модуля отдельно:

**0. Предварительная Конвертация (Опционально, вне основного конвейера):**
- Исходные `.docx` файлы конвертируются в `.md` с помощью `pandoc`.
- Изображения извлекаются и сохраняются в отдельную папку (например, `media/`).
- Полученные `.md` файлы и папка с изображениями помещаются в структуру Git-репозитория.
    

**Основной Конвейер:**

1. **Источник данных:** Markdown-файлы для каждого модуля хранятся в структурированном виде (папки по модулям) в **Git-репозитории**. Ссылки на изображения в `.md` указывают на извлеченные файлы.
    
2. **Модуль Предобработки:** Скрипт Node.js читает Markdown-файлы модуля, заменяет изображения на Mermaid-диаграммы (через LLM) и разделяет текст на чанки по заголовкам.
    
3. **Модуль Основной Обработки (LLM + Supabase):** Обработанные чанки передаются LLM (через OpenRouter) для извлечения структурированной информации. Результаты сохраняются в **Supabase**.
    
4. **Модуль Векторизации (vsegpt.ru + Qdrant):** Текстовые данные из Supabase векторизуются через vsegpt.ru и загружаются в **Qdrant**.
    
5. **Оркестрация и Деплоймент:** Весь основной конвейер (приложение Node.js, Supabase/PostgreSQL, Qdrant) управляется через **Coolify**.
    

```
graph TD
    subgraph "Предварительный Этап (Ручной/Скриптовый)"
        direction LR
        PRE_A[Исходные DOCX файлы] -- pandoc --> PRE_B{Конвертация};
        PRE_B -- .md файлы --> PRE_C[Структура для Git];
        PRE_B -- Изображения --> PRE_D[Папка media/];
        PRE_D --> PRE_C;
    end

    subgraph "Основной Автоматизированный Конвейер"
        direction LR
        A[Источник MD файлов (Git) по Модулям] --> B(Модуль Предобработки);
        B -- Чанки с Mermaid --> C{Модуль Основной Обработки};
        C -- Запрос к LLM --> D[OpenRouter API];
        D -- Ответ LLM --> C;
        C -- Структур. данные + module_id --> E[Supabase (PostgreSQL) @ Coolify];
        E -- Чанки/Вопросы + module_id --> F{Модуль Векторизации};
        F -- Текст для векторизации --> G[vsegpt.ru API (OpenAI model)];
        G -- Векторы --> F;
        F -- Векторы + payload (IDs, module_id) --> H[Qdrant DB (Единая Коллекция) @ Coolify];

        subgraph "Предобработка (Скрипт 1 - Node.js)"
            direction LR
            B_1(Чтение MD) --> B_2(Image -> Mermaid) --> B_3(Сплиттинг по Заголовкам)
            B_2 -- Вызов LLM --> D
        end

        subgraph "Конвейер Обработки (Скрипты 2, 3 - Node.js)"
            C
            F
        end

        subgraph "Хранилища (на Coolify)"
            E
            H
        end

        subgraph "Внешние Сервисы (вне Coolify)"
            A
            D
            G
        end
    end

    PRE_C --> A;

    style PRE_A fill:#eee,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
    style PRE_B fill:#eee,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
    style PRE_C fill:#eee,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
    style PRE_D fill:#eee,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style C fill:#ccf,stroke:#333,stroke-width:2px
    style F fill:#ccf,stroke:#333,stroke-width:2px
```

## **4. Функциональные Требования**

### **4.0. Предварительная Конвертация DOCX в Markdown (Вне основного конвейера)**

- **4.0.1. Инструмент:** Использовать утилиту `pandoc`.
    
- **4.0.2. Процесс:**
    
    - На вход подаются файлы формата `.docx`.
        
    - Выполняется команда `pandoc` для конвертации `.docx` в `.md`.
        
    - **Извлечение Медиа:** Использовать опцию `pandoc` (например, `--extract-media=./media` или аналогичную) для автоматического извлечения всех изображений из `.docx` в указанную подпапку (например, `media` относительно `.md` файла).
        
    - **Ссылки на Изображения:** `pandoc` должен автоматически обновить ссылки на изображения в генерируемом `.md` файле, чтобы они указывали на извлеченные файлы в папке `media`.
        
- **4.0.3. Результат:**
    
    - Набор `.md` файлов, готовых для размещения в Git-репозитории.
        
    - Папка (`media` или с другим настроенным именем) с извлеченными изображениями, которая также размещается в Git-репозитории рядом с соответствующими `.md` файлами или в общей папке для модуля.
        
- **4.0.4. Выполнение:** Этот шаг выполняется вручную или отдельным скриптом _перед_ тем, как данные попадут в Git и будут обработаны основным конвейером Node.js. Инструкции по выполнению должны быть включены в `README.md`.
    

### **4.1. Управление Источниками Данных (Основной конвейер)**

- **4.1.1. Структура Хранения:**
    
    - Использовать **Git-репозиторий**. Корневая папка содержит подпапки, названные по уникальному идентификатору модуля (например, `module_a`, `module_b`).
        
    - Внутри каждой папки модуля находятся `.md` файлы (полученные после конвертации из DOCX или созданные изначально) и, возможно, подпапка с изображениями (например, `media`), если они были извлечены на шаге 4.0.
        
- **4.1.2. Идентификация Модуля:** Система определяет `module_id` на основе имени папки, из которой обрабатываются файлы. Этот `module_id` используется на всех последующих этапах для изоляции данных.
    
- **4.1.3. Доступ:** Система должна иметь настроенный доступ (например, SSH-ключи или токен доступа) для клонирования/чтения файлов из **Git-репозитория**.
    

### **4.2. Модуль Предобработки (Node.js)**

Этот скрипт (или набор функций) запускается для указанного `module_id`.

- **4.2.1. Вход:** Путь к папке с Markdown-файлами для `module_id` (в локальной копии репозитория).
    
- **4.2.2. Чтение Файлов:** Рекурсивное чтение всех `.md` файлов из указанной папки. Обработка ошибок чтения.
    
- **4.2.3. Замена Изображений на Mermaid:**
    
    - Парсинг Markdown для обнаружения синтаксиса изображений (`![alt](url)`, `<img src="...">`). **Важно:** На этом этапе изображения уже могут быть локальными файлами в папке `media`, на которые ссылаются `.md` файлы.
        
    - Для каждого изображения:
        
        - Сформировать запрос к LLM (через OpenRouter), используя предоставленный пользователем промпт и контекст изображения (alt текст, **путь к файлу**, окружающий текст). _Примечание: передача самого файла изображения в LLM не входит в требования этого шага, используется только текстовый контекст._
            
        - Получить сгенерированный Mermaid-синтаксис.
            
        - Заменить исходный тег изображения на блок `mermaid\n{синтаксис}\n` в тексте Markdown.
            
        - Обработка ошибок API LLM.
            
- **4.2.4. Разделение по Заголовкам (Сплиттинг):**
    
    - Использовать библиотеку для парсинга Markdown в Node.js (например, `remark`).
        
    - Разделить содержимое каждого файла на чанки на основе иерархии заголовков.
        
    - Каждый чанк должен содержать свой текст и метаданные: `source_file_name`, `module_id`, иерархию заголовков, порядковый номер.
        
- **4.2.5. Выход:** Список объектов-чанков.
    

### **`4.3. Основной Конвейер Обработки (Node.js, для каждого module_id)`**

(Без изменений в этом разделе, обрабатывает чанки из 4.2)

- **4.3.1. Обработка Чанков через LLM (OpenRouter):** ...
    
- **4.3.2. Сохранение в Supabase (PostgreSQL):** ...
    
- **4.3.3. Векторизация и Загрузка в Qdrant:** ...
    

## **5. Модели Данных**

(Без изменений в этом разделе)

### **5.1. Схема Supabase (PostgreSQL)** ...

### **5.2. Структура Payload Вектора в Qdrant (Единая коллекция)** ...

## **6. Технические Требования**

- **Язык программирования:** **Node.js LTS**.
    
- **Основные зависимости (Node.js - примерный список):**
    
    - Среда выполнения: Node.js
        
    - HTTP-клиент: `axios` или `node-fetch`
        
    - Markdown Предобработка: `remark`, `remark-parse`, `remark-stringify`, `unist-util-visit`
        
    - AI/Векторизация: `@qdrant/js-client`, клиенты для OpenRouter API, vsegpt.ru API.
        
    - База данных: `@supabase/supabase-js`
        
    - Работа с Git: `simple-git` или `child_process`.
        
    - Конфигурация: `dotenv`
        
    - Логирование: `pino` или `winston`
        
- **Системные Зависимости (для окружения выполнения):**
    
    - **`pandoc`**: Необходим для выполнения шага предварительной конвертации (4.0). Должен быть установлен в системе, где запускается конвертация, или в Docker-образе, если конвертация автоматизирована как часть CI/CD или скрипта развертывания.
        
- **Инфраструктура:**
    
    - Docker Engine.
        
    - **Платформа Coolify** для развертывания:
        
        - Приложения Node.js (Docker-контейнер).
            
        - **Базы данных PostgreSQL (управляемой Supabase или нативной).**
            
        - **Векторной базы данных Qdrant.**
            
- **Внешние API (не развертываются на Coolify):**
    
    - Доступ к **Git-репозиторию**.
        
    - Аккаунт OpenRouter.
        
    - Доступ к API **vsegpt.ru**.
        

## **7. Нефункциональные Требования**

(Без изменений в этом разделе)

- **Обработка ошибок:** ...
    
- **Логирование:** ...
    
- **Конфигурация:** ...
    
- **Асинхронность:** ...
    
- **Идемпотентность (Желательно):** ...
    

## **8. Развертывание и Передача Заказчику**

- **Контейнеризация:** Приложение (скрипты конвейера Node.js) должно быть упаковано в Docker-образ. _Примечание: Если шаг конвертации DOCX автоматизируется, `pandoc` должен быть включен в соответствующий Docker-образ или доступен в среде выполнения._
    
- **Развертывание на Coolify:** ...
    
- **Передача Заказчику:**
    
    - Предоставление доступа к Git-репозиторию, содержащему:
        
        - Исходный код приложения на Node.js.
            
        - `Dockerfile`.
            
        - Файл `.env.example`.
            
        - `README.md` с подробными инструкциями по:
            
            - Настройке окружения (Docker, Node.js, Coolify, **установка `pandoc`**, если требуется).
                
            - Получению API-ключей.
                
            - Заполнению переменных окружения.
                
            - **Выполнению шага конвертации DOCX в MD (включая пример команды `pandoc`).**
                
            - **Подготовке Git-репозитория с `.md` файлами и папкой `media`.**
                
            - Процессу развертывания стека на Coolify.
                
            - Запуску основного конвейера для модуля.
                
            - Структуре входных данных в Git.
                

## **9. За рамками проекта (Out of Scope)**

- **Автоматизация шага конвертации DOCX в MD.** (Предполагается ручной или отдельный скриптовый запуск `pandoc`).
    
- Создание пользовательского интерфейса (UI)...
    
- Разработка API для внешнего взаимодействия...
    
- Реализация сложной логики автоматических повторных попыток...
    
- Автоматический запуск конвейера по расписанию...
    
- Система мониторинга...
    
- Реализация самого RAG-приложения...
    

## **10. Критерии Успеха**

- **Документы `.docx` успешно конвертируются в `.md` с помощью `pandoc` с извлечением изображений в отдельную папку.**
    
- Конвейер успешно обрабатывает Markdown-файлы (полученные после конвертации) для указанного `module_id` из **Git**.
    
- Изображения (ссылки на которые остались в MD после шага 4.2.3) корректно заменяются на Mermaid-диаграммы.
    
- Файлы корректно разделяются на чанки по заголовкам.
    
- Структурированные данные сохраняются в Supabase с правильным `module_id`.
    
- Данные для `module_id` успешно векторизуются и загружаются в Qdrant.
    
- Данные разных модулей логически изолированы.
    
- Система на **Node.js** успешно развертывается на Coolify.
    
- Процесс передачи заказчику понятен, **включая шаг конвертации DOCX**.
    
- Логи выполнения информативны.
    
- Конфигурация и секреты управляются через переменные окружения.
    

## **11. История Версий**

- **v1.3 (22.04.2025):** Добавлен опциональный предварительный шаг конвертации DOCX в Markdown с помощью `pandoc` и извлечением изображений. Обновлена архитектура, функциональные требования, технические требования и документация по передаче.
    
- **v1.2 (12.04.2025):** Добавлено уточнение, что инстансы Supabase/PostgreSQL и Qdrant также будут развернуты на Coolify.
    
- **v1.1 (12.04.2025):** Уточнены требования: источник данных - только Git, язык - только Node.js, стратегия Qdrant - единая коллекция с `module_id` в payload. Добавлено упоминание о планах на UI (n8n).
    
- **v1.0 (12.04.2025):** Начальная версия документа.